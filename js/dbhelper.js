'use strict';var _createClass=function(){function a(b,c){for(var e,d=0;d<c.length;d++)e=c[d],e.enumerable=e.enumerable||!1,e.configurable=!0,'value'in e&&(e.writable=!0),Object.defineProperty(b,e.key,e)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var DBHelper=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:'openDatabase',value:function openDatabase(){var b=idb.open('restaurants-db',1,function(c){c.objectStoreNames.contains('restaurants')||(console.log('Create IndexedDB store'),c.createObjectStore('restaurants',{keyPath:'id'}))});return b}},{key:'dbStore',value:function dbStore(b,c){c.then(function(d){var e=d.transaction('restaurants','readwrite'),f=e.objectStore('restaurants');return f.add(b),e.complete}).then(function(){})}},{key:'dbUpdate',value:function dbUpdate(b,c){c.then(function(d){var e=d.transaction('restaurants','readwrite'),f=e.objectStore('restaurants');return f.put(b),e.complete}).then(function(){})}},{key:'dbGetAll',value:function dbGetAll(b,c){b.then(function(d){var e=d.transaction('restaurants','readonly'),f=e.objectStore('restaurants');return f.getAll()}).then(function(d){c(d)})}},{key:'fetchRestaurants',value:function fetchRestaurants(b){var c=a.openDatabase();c.then(function(d){var e=d.transaction('restaurants','readonly'),f=e.objectStore('restaurants');return f.getAll()}).then(function(d){if(0==d.length)console.log('restaurants are empty'),fetch(a.DATABASE_URL,{method:'get'}).then(function(f){return f.json()}).then(function(f){f.forEach(function(g){a.dbStore(g,c)}),b(null,f)}).catch(function(f){b('Request failed. Returned status of '+f,null)});else a.dbGetAll(c,function(f){b(null,f)})})}},{key:'fetchRestaurantById',value:function fetchRestaurantById(b,c){a.fetchRestaurants(function(d,e){if(d)c(d,null);else{var f=e.find(function(g){return g.id==b});f?c(null,f):c('Restaurant does not exist',null)}})}},{key:'fetchRestaurantByCuisine',value:function fetchRestaurantByCuisine(b,c){a.fetchRestaurants(function(d,e){if(d)c(d,null);else{var f=e.filter(function(g){return g.cuisine_type==b});c(null,f)}})}},{key:'fetchRestaurantByNeighborhood',value:function fetchRestaurantByNeighborhood(b,c){a.fetchRestaurants(function(d,e){if(d)c(d,null);else{var f=e.filter(function(g){return g.neighborhood==b});c(null,f)}})}},{key:'fetchRestaurantByCuisineAndNeighborhood',value:function fetchRestaurantByCuisineAndNeighborhood(b,c,d,e){a.fetchRestaurants(function(f,g){if(f)e(f,null);else{var h=g;'all'!=b&&(h=h.filter(function(j){return j.cuisine_type==b})),'all'!=c&&(h=h.filter(function(j){return j.neighborhood==c})),!1!=d&&(h=h.filter(function(j){return!0==j.is_favorite||'true'==j.is_favorite})),e(null,h)}})}},{key:'fetchRestaurantByFavourite',value:function fetchRestaurantByFavourite(b){a.fetchRestaurants(function(c,d){if(c)b(c,null);else{var e=d;e=e.filter(function(f){return!0==f.is_favorite}),b(null,e)}})}},{key:'fetchNeighborhoods',value:function fetchNeighborhoods(b){a.fetchRestaurants(function(c,d){if(c)b(c,null);else{var e=d.map(function(g,h){return d[h].neighborhood}),f=e.filter(function(g,h){return e.indexOf(g)==h});b(null,f)}})}},{key:'fetchCuisines',value:function fetchCuisines(b){a.fetchRestaurants(function(c,d){if(c)b(c,null);else{var e=d.map(function(g,h){return d[h].cuisine_type}),f=e.filter(function(g,h){return e.indexOf(g)==h});b(null,f)}})}},{key:'urlForRestaurant',value:function urlForRestaurant(b){return'./restaurant.html?id='+b.id}},{key:'restaurantId',value:function restaurantId(b){return''+b.id}},{key:'imageUrlForRestaurant',value:function imageUrlForRestaurant(b){return'/img/'+b.id+'-large.webp'}},{key:'mapMarkerForRestaurant',value:function mapMarkerForRestaurant(b,c){var d=new google.maps.Marker({position:b.latlng,title:b.name,url:a.urlForRestaurant(b),map:c,animation:google.maps.Animation.DROP});return d}},{key:'openReviewDatabase',value:function openReviewDatabase(){var b=idb.open('reviews-db',1,function(c){c.objectStoreNames.contains('reviews')||(console.log('Create IndexedDB reviews store'),c.createObjectStore('reviews',{keyPath:'id'}))});return b}},{key:'dbReviewStore',value:function dbReviewStore(b,c){c.then(function(d){var e=d.transaction('reviews','readwrite'),f=e.objectStore('reviews');return f.put(b),e.complete}).then(function(){})}},{key:'dbReviewGetAll',value:function dbReviewGetAll(b,c){b.then(function(d){var e=d.transaction('reviews','readonly'),f=e.objectStore('reviews');return f.getAll()}).then(function(d){c(d)})}},{key:'dbReviewDeleteAll',value:function dbReviewDeleteAll(b){b.then(function(c){var d=c.transaction('reviews','readwrite');return d.objectStore('reviews').clear(),d.complete})}},{key:'openTempReviewDatabase',value:function openTempReviewDatabase(){var b=idb.open('temp-db',1,function(c){c.objectStoreNames.contains('reviews')||(console.log('Create IndexedDB temp reviews store'),c.createObjectStore('reviews',{keyPath:'temp_id',autoIncrement:!0}))});return b}},{key:'dbTempReviewStore',value:function dbTempReviewStore(b,c){return c.then(function(e){var f=e.transaction('reviews','readwrite'),g=f.objectStore('reviews');return g.add(b),f.complete})}},{key:'dbTempReviewGetAll',value:function dbTempReviewGetAll(b){return b.then(function(c){var d=c.transaction('reviews','readonly'),e=d.objectStore('reviews');return console.log('Getting cached reviews from IDB'),e.getAll()})}},{key:'dbTempReviewDelete',value:function dbTempReviewDelete(b){return b.then(function(d){var e=d.transaction('reviews','readwrite'),f=e.objectStore('reviews');f.delete(review.temp_id)})}},{key:'fetchRestaurantReviewsById',value:function fetchRestaurantReviewsById(b,c){var d=a.openReviewDatabase();fetch(a.REVIEWS_URL+b,{method:'get'}).then(function(e){return e.json()}).then(function(e){e.forEach(function(f){a.dbReviewStore(f,d)}),c(null,e)}).catch(function(){a.dbReviewGetAll(d,function(g){c(null,g)})})}},{key:'postData',value:function postData(b,c,d){return fetch(b,{method:c,headers:{'Content-Type':'application/json; charset=utf-8'},body:JSON.stringify(d)}).then(function(e){e.status;return e.json()}).catch(function(e){throw e})}},{key:'processReviews',value:function processReviews(){console.log('Processing Reviews'),a.dbTempReviewGetAll(a.openTempReviewDatabase()).then(function(b){Promise.all(b.map(function(c){a.postData('http://localhost:1337/reviews/','POST',c).then(function(d){return d.createdAt?void a.dbTempReviewDeleteAll(a.openTempReviewDatabase(),c.temp_id):Promise.reject('something went way wrong!')}).catch(function(d){console.error(d)})})).then(function(){}).catch(function(c){console.error(c)})}).catch(function(b){console.error(b)})}},{key:'DATABASE_URL',get:function get(){return'http://localhost:'+1337+'/restaurants'}},{key:'REVIEWS_URL',get:function get(){return'http://localhost:'+1337+'/reviews/?restaurant_id='}}]),a}();